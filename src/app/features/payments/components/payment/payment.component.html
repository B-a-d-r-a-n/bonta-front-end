<div class="container mx-auto px-4 py-8">
  <div class="max-w-4xl mx-auto">
    <h1 class="text-3xl font-bold text-gray-900 mb-8">Payment</h1>

    @if (isBasketLoading()) {
    <div class="flex justify-center items-center h-64">
      <p-progressSpinner styleClass="w-12 h-12" />
    </div>
    } @else if (basketError()) {
    <p-message severity="error" size="small" variant="simple" styleClass="mb-4">
      Failed to load basket information.
    </p-message>
    } @else {
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <!-- Payment Form -->
      <div>
        <p-card header="Payment Information" styleClass="shadow-md">
          <form #paymentForm="ngForm" class="space-y-6">
            <!-- Payment Method Selection -->
            <div class="flex flex-col gap-1">
              <label class="font-semibold text-gray-700">Payment Method</label>
              <div class="space-y-3">
                <div class="flex items-center">
                  <p-radioButton
                    name="paymentMethod"
                    value="card"
                    [(ngModel)]="selectedPaymentMethod"
                    [inputId]="'card'"
                    styleClass="mr-3"
                  ></p-radioButton>
                  <label
                    for="card"
                    class="text-sm text-gray-700 cursor-pointer"
                  >
                    Credit/Debit Card
                  </label>
                </div>
                <div class="flex items-center">
                  <p-radioButton
                    name="paymentMethod"
                    value="paypal"
                    [(ngModel)]="selectedPaymentMethod"
                    [inputId]="'paypal'"
                    styleClass="mr-3"
                  ></p-radioButton>
                  <label
                    for="paypal"
                    class="text-sm text-gray-700 cursor-pointer"
                  >
                    PayPal
                  </label>
                </div>
              </div>
            </div>

            <!-- Card Information (if card selected) -->
            @if (selectedPaymentMethod() === 'card') {
            <div class="space-y-4">
              <div class="flex flex-col gap-1">
                <label for="cardNumber" class="font-semibold text-gray-700"
                  >Card Number</label
                >
                <input
                  pInputText
                  id="cardNumber"
                  type="text"
                  placeholder="1234 5678 9012 3456"
                  [(ngModel)]="cardNumber"
                  name="cardNumber"
                  #cardNumberModel="ngModel"
                  [invalid]="
                    cardNumberModel.invalid &&
                    (cardNumberModel.touched || paymentForm.submitted)
                  "
                  styleClass="w-full"
                  inputStyleClass="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  aria-label="Card number"
                  aria-describedby="cardNumber-error"
                  tabindex="0"
                />
                @if (cardNumberModel.invalid && (cardNumberModel.touched ||
                paymentForm.submitted)) {
                <p-message
                  id="cardNumber-error"
                  severity="error"
                  size="small"
                  variant="simple"
                  styleClass="mt-1"
                >
                  Please enter a valid card number.
                </p-message>
                }
              </div>

              <div class="grid grid-cols-2 gap-4">
                <div class="flex flex-col gap-1">
                  <label for="expiryDate" class="font-semibold text-gray-700"
                    >Expiry Date</label
                  >
                  <input
                    pInputText
                    id="expiryDate"
                    type="text"
                    placeholder="MM/YY"
                    [(ngModel)]="expiryDate"
                    name="expiryDate"
                    #expiryDateModel="ngModel"
                    [invalid]="
                      expiryDateModel.invalid &&
                      (expiryDateModel.touched || paymentForm.submitted)
                    "
                    styleClass="w-full"
                    inputStyleClass="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    aria-label="Expiry date"
                    aria-describedby="expiryDate-error"
                    tabindex="0"
                  />
                  @if (expiryDateModel.invalid && (expiryDateModel.touched ||
                  paymentForm.submitted)) {
                  <p-message
                    id="expiryDate-error"
                    severity="error"
                    size="small"
                    variant="simple"
                    styleClass="mt-1"
                  >
                    Please enter a valid expiry date.
                  </p-message>
                  }
                </div>

                <div class="flex flex-col gap-1">
                  <label for="cvv" class="font-semibold text-gray-700"
                    >CVV</label
                  >
                  <input
                    pInputText
                    id="cvv"
                    type="text"
                    placeholder="123"
                    [(ngModel)]="cvv"
                    name="cvv"
                    #cvvModel="ngModel"
                    [invalid]="
                      cvvModel.invalid &&
                      (cvvModel.touched || paymentForm.submitted)
                    "
                    styleClass="w-full"
                    inputStyleClass="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    aria-label="CVV"
                    aria-describedby="cvv-error"
                    tabindex="0"
                  />
                  @if (cvvModel.invalid && (cvvModel.touched ||
                  paymentForm.submitted)) {
                  <p-message
                    id="cvv-error"
                    severity="error"
                    size="small"
                    variant="simple"
                    styleClass="mt-1"
                  >
                    Please enter a valid CVV.
                  </p-message>
                  }
                </div>
              </div>
            </div>
            }

            <!-- Billing Address -->
            <div class="flex flex-col gap-1">
              <label for="billingAddress" class="font-semibold text-gray-700"
                >Billing Address</label
              >
              <textarea
                pInputText
                id="billingAddress"
                placeholder="Enter your billing address"
                [(ngModel)]="billingAddress"
                name="billingAddress"
                #billingAddressModel="ngModel"
                [invalid]="
                  billingAddressModel.invalid &&
                  (billingAddressModel.touched || paymentForm.submitted)
                "
                [rows]="3"
                styleClass="w-full"
                inputStyleClass="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                aria-label="Billing address"
                aria-describedby="billingAddress-error"
                tabindex="0"
              ></textarea>
              @if (billingAddressModel.invalid && (billingAddressModel.touched
              || paymentForm.submitted)) {
              <p-message
                id="billingAddress-error"
                severity="error"
                size="small"
                variant="simple"
                styleClass="mt-1"
              >
                Please enter your billing address.
              </p-message>
              }
            </div>

            <!-- Terms and Conditions -->
            <div class="flex items-center">
              <p-checkbox
                id="terms"
                [(ngModel)]="acceptedTerms"
                name="terms"
                [binary]="true"
                styleClass="mr-3"
              ></p-checkbox>
              <label for="terms" class="text-sm text-gray-700 cursor-pointer">
                I agree to the
                <a href="#" class="text-blue-600 hover:underline"
                  >Terms and Conditions</a
                >
              </label>
            </div>

            <!-- Payment Button -->
            <p-button
              label="Pay Now"
              icon="pi pi-credit-card"
              [disabled]="!acceptedTerms() || isPaymentPending()"
              [loading]="isPaymentPending()"
              (click)="processPayment()"
              [rounded]="true"
              styleClass="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-colors duration-200"
              aria-label="Process payment"
            ></p-button>
          </form>
        </p-card>
      </div>

      <!-- Order Summary -->
      <div>
        <p-card header="Order Summary" styleClass="shadow-md">
          <div class="space-y-4">
            <!-- Items -->
            @for (item of basketData()?.items; track item.id) {
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-3">
                <img
                  [src]="item.pictureUrl"
                  [alt]="item.productName"
                  class="w-12 h-12 object-cover rounded"
                />
                <div>
                  <div class="font-medium text-gray-900">
                    {{ item.productName }}
                  </div>
                  <div class="text-sm text-gray-500">
                    Qty: {{ item.quantity }}
                  </div>
                </div>
              </div>
              <div class="font-medium text-gray-900">
                {{ item.price * item.quantity | currency }}
              </div>
            </div>
            }

            <p-divider></p-divider>

            <!-- Totals -->
            <div class="space-y-2">
              <div class="flex justify-between text-sm text-gray-600">
                <span>Subtotal</span>
                <span>{{ getSubtotal() | currency }}</span>
              </div>
              <div class="flex justify-between text-sm text-gray-600">
                <span>Shipping</span>
                <span>{{ basketData()?.shippingPrice || 0 | currency }}</span>
              </div>
              <div class="flex justify-between text-sm text-gray-600">
                <span>Tax</span>
                <span>{{ getTax() | currency }}</span>
              </div>
              <p-divider></p-divider>
              <div class="flex justify-between font-bold text-lg">
                <span>Total</span>
                <span>{{ getTotal() | currency }}</span>
              </div>
            </div>
          </div>
        </p-card>

        <!-- Security Notice -->
        <div class="mt-4 p-4 bg-blue-50 rounded-lg">
          <div class="flex items-center space-x-2">
            <i class="pi pi-shield text-blue-600" aria-hidden="true"></i>
            <span class="text-sm text-blue-800">
              Your payment information is secure and encrypted
            </span>
          </div>
        </div>
      </div>
    </div>
    }
  </div>
</div>

<p-toast></p-toast>
